#!/bin/bash

CONFIG_FILE='../configs/jira-backup.conf'
TIMESTAMP=$(date +'%Y-%m-%d-%H-%M')

if [ -e ${CONFIG_FILE} ]; then
    source ${CONFIG_FILE}
else
    echo "Error: ${CONFIG_FILE} missing"
    exit 1
fi

JIRA_BACKUP_OUTPUT="${BACKUP_DIR}/jira-home-${TIMESTAMP}.tar"
JIRA_DATABASE_DUMP_OUTPUT="${BACKUP_DIR}/jira-database-dump-${TIMESTAMP}.sql"
CONFLUENCE_BACKUP_OUTPUT="${BACKUP_DIR}/confluence-home-${TIMESTAMP}.tar"
CONFLUENCE_DATABASE_DUMP_OUTPUT="${BACKUP_DIR}/confluence-database-dump-${TIMESTAMP}.sql"


function setup() {
    if [ ! -d "${BACKUP_DIR}" ]; then
        echo "Creating ${BACKUP_DIR}"
        mkdir -p "${BACKUP_DIR}"
    fi
}

function backup_jira-home() {
    echo "Backing up Jira home dirrectory"
    /bin/tar -cpf ${JIRA_BACKUP_OUTPUT} ${JIRA-HOME_PATH}
    echo "Created ${JIRA_BACKUP_OUTPUT}"
}

function dump_database_jira() {
    echo "Dumping Jira database"
    /usr/bin/mysqldump --add-drop-database --host="${DB_HOST_JIRA}" --user="${DB_USER_JIRA}" --password="${DB_PASS_JIRA}" "${DB_NAME_JIRA}" > "${DATABASE_DUMP_OUTPUT}"
    echo "Created ${DATABASE_DUMP_OUTPUT}"
}

function backup_confluence-home() {
    echo "Backing up Confluence home dirrectory"
    /bin/tar -cpf ${JIRA_BACKUP_OUTPUT} ${JIRA-HOME_PATH}
    echo "Created ${JIRA_BACKUP_OUTPUT}"
}

function dump_database_jira() {
    echo "Dumping Jira database"
    /usr/bin/mysqldump --add-drop-database --host="${DB_HOST_JIRA}" --user="${DB_USER_JIRA}" --password="${DB_PASS_JIRA}" "${DB_NAME_JIRA}" > "${DATABASE_DUMP_OUTPUT}"
    echo "Created ${DATABASE_DUMP_OUTPUT}"
}

function main_jira() {
    echo "Backing up Jira"
    setup
    backup_jira-home
    dump_database_jira
}

main_jira
main_confluence

